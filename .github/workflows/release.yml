name: 'Release'

on:
    pull_request:
        types: [closed]
        branches: [main]
    workflow_dispatch:

permissions:
    contents: read

# Concurrency control: only one release process can run at a time
# This prevents race conditions if multiple PRs with 'release' label merge simultaneously
concurrency:
    group: release
    cancel-in-progress: false

jobs:
    check-release-label:
        name: Check for release label
        runs-on: ubuntu-latest
        # Run when PR with 'release' label is merged to main, or on manual dispatch
        if: |
            github.event_name == 'workflow_dispatch' ||
            (github.event_name == 'pull_request' &&
             github.event.pull_request.merged == true &&
             contains(github.event.pull_request.labels.*.name, 'release'))
        outputs:
            should-release: ${{ steps.check.outputs.should-release }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: main
                  fetch-depth: 0

            - name: Check release conditions
              id: check
              run: |
                  changeset_count=$(find .changeset -name '*.md' ! -name 'README.md' 2>/dev/null | wc -l)
                  if [ "$changeset_count" -gt 0 ]; then
                    echo "should-release=true" >> "$GITHUB_OUTPUT"
                    echo "Found $changeset_count changeset(s), ready to release"
                  else
                    echo "should-release=false" >> "$GITHUB_OUTPUT"
                    echo "No changesets to release"
                  fi

    notify-approval-needed:
        name: Notify Slack - Approval Needed
        needs: check-release-label
        if: needs.check-release-label.outputs.should-release == 'true'
        uses: posthog/.github/.github/workflows/notify-approval-needed.yml@main
        with:
            slack_channel_id: ${{ vars.SLACK_APPROVALS_CLIENT_LIBRARIES_CHANNEL_ID }}
            slack_user_group_id: ${{ vars.GROUP_CLIENT_LIBRARIES_SLACK_GROUP_ID }}
        secrets:
            slack_bot_token: ${{ secrets.SLACK_CLIENT_LIBRARIES_BOT_TOKEN }}
            posthog_project_api_key: ${{ secrets.POSTHOG_PROJECT_API_KEY }}

    release:
        name: Release and publish
        needs: [check-release-label, notify-approval-needed]
        runs-on: ubuntu-latest
        if: always() && needs.check-release-label.outputs.should-release == 'true'
        environment: 'Release'
        permissions:
            contents: write
            actions: write
            id-token: write
        steps:
            - name: Notify Slack - Approved
              if: needs.notify-approval-needed.outputs.slack_ts != ''
              uses: posthog/.github/.github/actions/slack-thread-reply@main
              with:
                  slack_bot_token: ${{ secrets.SLACK_CLIENT_LIBRARIES_BOT_TOKEN }}
                  slack_channel_id: ${{ vars.SLACK_APPROVALS_CLIENT_LIBRARIES_CHANNEL_ID }}
                  thread_ts: ${{ needs.notify-approval-needed.outputs.slack_ts }}
                  message: '‚úÖ Release approved! Version bump in progress...'
                  emoji_reaction: 'white_check_mark'

            - name: Get GitHub App token
              id: releaser
              uses: actions/create-github-app-token@v2
              with:
                  app-id: ${{ secrets.GH_APP_RELEASER_APP_ID }}
                  private-key: ${{ secrets.GH_APP_RELEASER_PRIVATE_KEY }}

            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: main
                  fetch-depth: 0
                  token: ${{ steps.releaser.outputs.token }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  registry-url: https://registry.npmjs.org
                  cache: npm

            - name: Install dependencies
              run: npm ci

            - name: Configure Git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Version packages with changesets
              id: changeset-version
              run: |
                  npx changeset version
                  new_version=$(node -p "require('./package.json').version")
                  echo "new_version=$new_version" >> "$GITHUB_OUTPUT"

            - name: Commit release changes
              id: commit-release
              env:
                  GITHUB_TOKEN: ${{ steps.releaser.outputs.token }}
              run: |
                  git add -A
                  if git diff --staged --quiet; then
                    echo "No changes to commit"
                    echo "committed=false" >> "$GITHUB_OUTPUT"
                  else
                    git commit -m "chore: Release v${{ steps.changeset-version.outputs.new_version }}"
                    git push origin main
                    echo "committed=true" >> "$GITHUB_OUTPUT"
                  fi

            - name: Typecheck
              if: steps.commit-release.outputs.committed == 'true'
              run: npx tsc --noEmit

            - name: Test
              if: steps.commit-release.outputs.committed == 'true'
              run: npx vitest run

            - name: Publish to npm (OIDC provenance)
              if: steps.commit-release.outputs.committed == 'true'
              run: npm publish --access public --provenance
              env:
                  NPM_CONFIG_PROVENANCE: true

            - name: Push tags
              if: steps.commit-release.outputs.committed == 'true'
              run: |
                  git tag "v${{ steps.changeset-version.outputs.new_version }}"
                  git push origin --tags

            - name: Create GitHub Release
              if: steps.commit-release.outputs.committed == 'true'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: gh release create "v${{ steps.changeset-version.outputs.new_version }}" --generate-notes

            - name: Send failure event to PostHog
              if: ${{ failure() }}
              uses: PostHog/posthog-github-action@v0.1
              with:
                  posthog-token: '${{ secrets.POSTHOG_PROJECT_API_KEY }}'
                  event: 'posthog-openclaw-github-release-workflow-failure'
                  properties: >-
                      {
                        "commitSha": "${{ github.sha }}",
                        "jobStatus": "${{ job.status }}",
                        "ref": "${{ github.ref }}",
                        "version": "v${{ steps.changeset-version.outputs.new_version }}"
                      }

            - name: Notify Slack - Failed
              if: ${{ failure() && needs.notify-approval-needed.outputs.slack_ts != '' }}
              uses: posthog/.github/.github/actions/slack-thread-reply@main
              with:
                  slack_bot_token: ${{ secrets.SLACK_CLIENT_LIBRARIES_BOT_TOKEN }}
                  slack_channel_id: ${{ vars.SLACK_APPROVALS_CLIENT_LIBRARIES_CHANNEL_ID }}
                  thread_ts: ${{ needs.notify-approval-needed.outputs.slack_ts }}
                  message: '‚ùå Failed to release `@posthog/openclaw@v${{ steps.changeset-version.outputs.new_version }}`! <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View logs>'
                  emoji_reaction: 'x'

    notify-released:
        name: Notify Slack - Released
        needs: [check-release-label, notify-approval-needed, release]
        runs-on: ubuntu-latest
        if: always() && needs.release.result == 'success' && needs.notify-approval-needed.outputs.slack_ts != ''
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Notify Slack - Released
              uses: posthog/.github/.github/actions/slack-thread-reply@main
              with:
                  slack_bot_token: ${{ secrets.SLACK_CLIENT_LIBRARIES_BOT_TOKEN }}
                  slack_channel_id: ${{ vars.SLACK_APPROVALS_CLIENT_LIBRARIES_CHANNEL_ID }}
                  thread_ts: ${{ needs.notify-approval-needed.outputs.slack_ts }}
                  message: 'üöÄ @posthog/openclaw released successfully!'
                  emoji_reaction: 'rocket'
